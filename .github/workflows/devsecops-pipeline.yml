name: DevSecOps CI/CD Pipeline

# Workflow permissions (allows creating check runs)
permissions:
  contents: read
  checks: write

# Triggers: run on every push and pull request to main/develop
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # -------------------------------------------------------
  # STAGE 1: BUILD
  # -------------------------------------------------------
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Compile with Maven
        run: mvn clean compile -B

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: target/

  # -------------------------------------------------------
  # STAGE 2: UNIT TESTS
  # -------------------------------------------------------
  test:
    name: Run Automated Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run unit tests with JaCoCo coverage
        run: mvn test jacoco:report -B

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/jacoco/

      - name: Publish test summary
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: JUnit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit

  # -------------------------------------------------------
  # STAGE 3: SECURITY SCANNING (SCA - Real OWASP check)
  # -------------------------------------------------------
  security-sca:
    name: SCA - OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run OWASP Dependency Check (SCA)
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=9 \
            -Dformat=ALL \
            -B || true

      - name: Upload OWASP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-report
          path: target/dependency-check-report.*

  # -------------------------------------------------------
  # STAGE 4: STATIC ANALYSIS (SAST)
  # -------------------------------------------------------
  security-sast:
    name: SAST - Static Code Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run SpotBugs static analysis
        run: |
          mvn compile spotbugs:check -B || true

      - name: Run Checkstyle code standards check
        run: |
          mvn checkstyle:check -B || true

      - name: Upload SAST reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: target/spotbugs*.xml

  # -------------------------------------------------------
  # STAGE 5: DYNAMIC APPLICATION SECURITY TESTING (DAST)
  # -------------------------------------------------------
  security-dast:
    name: DAST - OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          # Target a placeholder URL - in production this would be a deployed instance
          target: "https://example.com"
          rules_file_name: ".zap/rules.tsv"
          allow_issue_writing: false
        continue-on-error: true

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-report
          path: report_html.html

  # -------------------------------------------------------
  # STAGE 6: SECURITY GATE (pass/fail decision)
  # -------------------------------------------------------
  security-gate:
    name: Security Gate Evaluation
    runs-on: ubuntu-latest
    needs: [test, security-sca, security-sast, security-dast]

    steps:
      - name: Download OWASP report
        uses: actions/download-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: security-reports/

      - name: Evaluate security gate
        run: |
          echo "================================================="
          echo "SECURITY GATE EVALUATION"
          echo "================================================="

          GATE_PASSED=true

          # Check OWASP report for high/critical CVEs (CVSS >= 7.0)
          if [ -f "security-reports/dependency-check-report.json" ]; then
            HIGH_CVE=$(python3 -c "
          import json, sys
          with open('security-reports/dependency-check-report.json') as f:
              data = json.load(f)
          deps = data.get('dependencies', [])
          high = [v for d in deps
                    for v in d.get('vulnerabilities', [])
                    if v.get('cvssv3', {}).get('baseScore', 0) >= 7.0]
          print(len(high))
          " 2>/dev/null || echo "0")

            echo "High/Critical CVEs (CVSS >= 7.0): $HIGH_CVE"

            if [ "$HIGH_CVE" -gt 0 ]; then
              echo "SECURITY GATE FAILED: $HIGH_CVE critical vulnerabilities detected"
              GATE_PASSED=false
            fi
          else
            echo "OWASP report not found - skipping CVE check"
          fi

          if [ "$GATE_PASSED" = true ]; then
            echo "SECURITY GATE PASSED - Deployment approved"
          else
            exit 1
          fi

  # -------------------------------------------------------
  # STAGE 7: DEPLOY (only on main branch, after all checks)
  # -------------------------------------------------------
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: security-gate
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to environment
        run: |
          echo "All security gates passed."
          echo "Deploying SecureVision Platform Application..."
          echo "Deployment complete."
